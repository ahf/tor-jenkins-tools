#!/bin/bash

set -e
set -x
set -u

# Stuff that is run in the chroot as root
setup() {
	echo "Update package list"
	for i in 1 2 3 4 5; do
		apt-get update && break;
		sleep 30;
	done;

	echo "Install build dependencies"
	apt-get install -y python pyflakes tor
}

# Stuff that is run in the chroot as user
run() {
	echo "Cleanup build dir"
	rm -rf build

	echo "Run unittests"
	python ./run_tests.py --unit

	echo "Run integration tests against latest tor binary"
	python ./run_tests.py --tor src/or/tor --integ --target RUN_ALL
}



fullpath=$(readlink -f "$0")
dir=$(dirname "$fullpath")
common="$dir/../build-wrapper.common"
for common in "$dir/../build-wrapper.common" "$dir/build-wrapper.common"; do
	if [ -e "$common" ]; then
		. "$common"
		exit 0
	fi
done
echo >&2 "build-wrapper.common not found."
exit 1
