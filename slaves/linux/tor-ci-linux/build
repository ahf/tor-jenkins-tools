#!/bin/bash
set -x
set -e

configure_flags=${configure_flags:-"--enable-gcc-warnings --disable-silent-rules"}

cd tor && ./autogen.sh

set dummy ${configure_flags}
shift

echo "======================================================="
echo "== Running with configure $*"
echo "======================================================="

rm -rf build-tree-tor RESULT
mkdir build-tree-tor RESULT

(
cd build-tree-tor
../tor/configure "$@"
make -k
TOR_FUZZ_CORPORA=../fuzzing-corpora VERBOSE=yes make -k check
)

cp build-tree-tor/src/or/tor RESULT
rm -rf build-tree-tor
